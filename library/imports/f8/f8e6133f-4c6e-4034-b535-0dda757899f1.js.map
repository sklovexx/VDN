{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\NiuNiu\\script\\common/assets\\NiuNiu\\script\\common\\one-side-platform.js"],"names":["PenetrateSide","cc","Enum","UP_TO_DOWN","DOWN_TO_UP","LEFT_TO_RIGHT","RIGHT_TO_LEFT","Class","extends","Component","properties","penetrateSide","tooltip","type","default","onLoad","pointVelPlatform","v2","pointVelOther","relativeVel","relativePoint","onBeginContact","contact","selfCollider","otherCollider","cache","_pointsCache","otherBody","body","platformBody","worldManifold","getWorldManifold","points","i","length","getLinearVelocityFromWorldPoint","getLocalVector","subSelf","y","getLocalPoint","platformFaceY","getAABB","height","x","log","platformFaceX","width","disabled"],"mappings":";;;;;;AAAA;AACA;;AAEA,IAAIA,gBAAgBC,GAAGC,IAAH,CAAQ;AACxBC,gBAAY,CADY;AAExBC,gBAAY,CAFY;AAGxBC,mBAAe,CAHS;AAIxBC,mBAAe;AAJS,CAAR,CAApB;AAMAL,GAAGM,KAAH,CAAS;AACLC,aAASP,GAAGQ,SADP;;AAGLC,gBAAY;AACRC,uBAAe;AACXC,qBAAS,MADE;AAEXC,kBAAMb,aAFK;AAGXc,qBAASd,cAAcI;AAHZ;AADP,KAHP;;AAWLW,YAAQ,kBAAY;AAChB,aAAKC,gBAAL,GAAwBf,GAAGgB,EAAH,EAAxB;AACA,aAAKC,aAAL,GAAqBjB,GAAGgB,EAAH,EAArB;AACA,aAAKE,WAAL,GAAmBlB,GAAGgB,EAAH,EAAnB;AACA,aAAKG,aAAL,GAAqBnB,GAAGgB,EAAH,EAArB;AACH,KAhBI;;AAkBLI,oBAAgB,wBAAUC,OAAV,EAAmBC,YAAnB,EAAiCC,aAAjC,EAAgD;AAC5D,YAAIC,QAAQ,KAAKC,YAAjB;;AAEA,YAAIC,YAAYH,cAAcI,IAA9B;AACA,YAAIC,eAAeN,aAAaK,IAAhC;;AAEA,YAAIE,gBAAgBR,QAAQS,gBAAR,EAApB;AACA,YAAIC,SAASF,cAAcE,MAA3B;;AAEA,YAAIhB,mBAAmB,KAAKA,gBAA5B;AACA,YAAIE,gBAAgB,KAAKA,aAAzB;AACA,YAAIC,cAAc,KAAKA,WAAvB;AACA,YAAIC,gBAAgB,KAAKA,aAAzB;;AAEA;AACA,aAAK,IAAIa,IAAI,CAAb,EAAgBA,IAAID,OAAOE,MAA3B,EAAmCD,GAAnC,EAAwC;AACpCJ,yBAAaM,+BAAb,CAA8CH,OAAOC,CAAP,CAA9C,EAAyDjB,gBAAzD;AACAW,sBAAUQ,+BAAV,CAA2CH,OAAOC,CAAP,CAA3C,EAAsDf,aAAtD;AACAW,yBAAaO,cAAb,CAA6BlB,cAAcmB,OAAd,CAAsBrB,gBAAtB,CAA7B,EAAsEG,WAAtE;;AAEA;AACA,gBAAI,KAAKR,aAAL,KAAuBX,cAAcI,UAAzC,EAAoD;AAChD,oBAAKe,YAAYmB,CAAZ,GAAgB,CAAC,EAAtB,EAA2B;AACvB,2BADJ,CACa;AADb,qBAEK,IAAKnB,YAAYmB,CAAZ,GAAgB,EAArB,EAA0B;AAAE;AAC7B;AACAT,qCAAaU,aAAb,CAA4BP,OAAOC,CAAP,CAA5B,EAAuCb,aAAvC;AACA,4BAAIoB,gBAAgBjB,aAAakB,OAAb,GAAuBC,MAAvB,GAAgC,CAApD,CAH2B,CAG6B;AACxD,4BAAKtB,cAAckB,CAAd,GAAkBE,gBAAgB,MAAI,EAA3C,EACI,OALuB,CAKd;AAChB,qBANI,MAOA;AACD;AACH;AACJ,aAbD,MAaO,IAAI,KAAK7B,aAAL,KAAuBX,cAAcG,UAAzC,EAAoD;AACvD,oBAAKgB,YAAYmB,CAAZ,GAAgB,EAArB,EAA0B;AACtB,2BADJ,CACa;AADb,qBAEK,IAAKnB,YAAYmB,CAAZ,GAAgB,CAAC,EAAtB,EAA2B;AAAE;AAC9B;AACAT,qCAAaU,aAAb,CAA4BP,OAAOC,CAAP,CAA5B,EAAuCb,aAAvC;AACA,4BAAIoB,iBAAgBjB,aAAakB,OAAb,GAAuBC,MAAvB,GAAgC,CAApD,CAH4B,CAG4B;AACxD,4BAAKtB,cAAckB,CAAd,GAAkBE,iBAAgB,MAAI,EAA3C,EACI,OALwB,CAKf;AAChB,qBANI,MAOA;AACD;AACH;AACJ,aAbM,MAaA,IAAI,KAAK7B,aAAL,KAAuBX,cAAcK,aAAzC,EAAwD;AAC3D,oBAAIc,YAAYwB,CAAZ,GAAgB,CAAC,EAArB,EAAyB;AACrB,2BADJ,CACa;AADb,qBAEK,IAAIxB,YAAYwB,CAAZ,GAAgB,EAApB,EAAwB;AAAE;AAC3B1C,2BAAG2C,GAAH,CAAO,WAAP;AACA;AACAf,qCAAaU,aAAb,CAA2BP,OAAOC,CAAP,CAA3B,EAAsCb,aAAtC;AACA,4BAAIyB,gBAAgBtB,aAAakB,OAAb,GAAuBK,KAAvB,GAA+B,CAAnD,CAJyB,CAI8B;AACvD,4BAAI1B,cAAcuB,CAAd,GAAkBE,gBAAgB,MAAM,EAA5C,EACI,OANqB,CAMZ;AAChB,qBAPI,MAQA;AACD;AACH;AAEJ,aAfM,MAeA,IAAI,KAAKlC,aAAL,KAAuBX,cAAcM,aAAzC,EAAuD;AAC1D,oBAAKa,YAAYwB,CAAZ,GAAgB,EAArB,EAA0B;AACtB,2BADJ,CACa;AADb,qBAEK,IAAKxB,YAAYwB,CAAZ,GAAgB,CAAC,EAAtB,EAA2B;AAAE;AAC9B;AACAd,qCAAaU,aAAb,CAA4BP,OAAOC,CAAP,CAA5B,EAAuCb,aAAvC;AACA,4BAAIyB,iBAAgBtB,aAAakB,OAAb,GAAuBK,KAAvB,GAA+B,CAAnD,CAH4B,CAG2B;AACvD,4BAAK1B,cAAcuB,CAAd,GAAkBE,iBAAgB,MAAI,EAA3C,EACI,OALwB,CAKf;AAChB,qBANI,MAOA;AACD;AACH;AACJ;AAEJ;;AAED;AACAvB,gBAAQyB,QAAR,GAAmB,IAAnB;AACH;;AAED;AACA;;AAEA;AAxGK,CAAT","file":"one-side-platform.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\NiuNiu\\script\\common","sourcesContent":["// http://www.iforce2d.net/b2dtut/one-way-walls\r\n// 物理系统，单面穿透，其他面碰撞\r\n\r\nlet PenetrateSide = cc.Enum({\r\n    UP_TO_DOWN: 1,\r\n    DOWN_TO_UP: 2,\r\n    LEFT_TO_RIGHT: 3,\r\n    RIGHT_TO_LEFT: 4\r\n});\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        penetrateSide: {\r\n            tooltip: \"穿透方向\",\r\n            type: PenetrateSide,\r\n            default: PenetrateSide.DOWN_TO_UP\r\n        }\r\n    },\r\n\r\n    onLoad: function () {\r\n        this.pointVelPlatform = cc.v2();\r\n        this.pointVelOther = cc.v2();\r\n        this.relativeVel = cc.v2();\r\n        this.relativePoint = cc.v2();\r\n    },\r\n\r\n    onBeginContact: function (contact, selfCollider, otherCollider) {\r\n        let cache = this._pointsCache;\r\n\r\n        let otherBody = otherCollider.body;\r\n        let platformBody = selfCollider.body;\r\n\r\n        let worldManifold = contact.getWorldManifold();\r\n        let points = worldManifold.points;\r\n\r\n        let pointVelPlatform = this.pointVelPlatform;\r\n        let pointVelOther = this.pointVelOther;\r\n        let relativeVel = this.relativeVel;\r\n        let relativePoint = this.relativePoint;\r\n\r\n        //check if contact points are moving into platform\r\n        for (let i = 0; i < points.length; i++) {\r\n            platformBody.getLinearVelocityFromWorldPoint( points[i], pointVelPlatform );\r\n            otherBody.getLinearVelocityFromWorldPoint( points[i], pointVelOther );\r\n            platformBody.getLocalVector( pointVelOther.subSelf(pointVelPlatform), relativeVel );\r\n\r\n            // 原始代码（只有从下往上穿透，即 PenetrateSide.DOWN_TO_UP)\r\n            if (this.penetrateSide === PenetrateSide.DOWN_TO_UP){\r\n                if ( relativeVel.y < -32 ) //if moving down faster than 32 pixel/s (1m/s), handle as before\r\n                    return;  //point is moving into platform, leave contact solid and exit\r\n                else if ( relativeVel.y < 32 ) { //if moving slower than 32 pixel/s (1m/s)\r\n                    //borderline case, moving only slightly out of platform\r\n                    platformBody.getLocalPoint( points[i], relativePoint );\r\n                    let platformFaceY = selfCollider.getAABB().height / 2;  //front of platform, should only used on a box collider\r\n                    if ( relativePoint.y > platformFaceY - 0.1*32 )\r\n                        return;  //contact point is less than 3.2pixel (10cm) inside front face of platfrom\r\n                }\r\n                else {\r\n                    //moving up faster than 1 m/s\r\n                }\r\n            } else if (this.penetrateSide === PenetrateSide.UP_TO_DOWN){\r\n                if ( relativeVel.y > 32 ) //if moving up faster than 32 pixel/s (1m/s), handle as before\r\n                    return;  //point is moving into platform, leave contact solid and exit\r\n                else if ( relativeVel.y < -32 ) { //if moving slower than 32 pixel/s (1m/s)\r\n                    //borderline case, moving only slightly out of platform\r\n                    platformBody.getLocalPoint( points[i], relativePoint );\r\n                    let platformFaceY = selfCollider.getAABB().height / 2;  //front of platform, should only used on a box collider\r\n                    if ( relativePoint.y < platformFaceY - 0.1*32 )\r\n                        return;  //contact point is less than 3.2pixel (10cm) inside front face of platfrom\r\n                }\r\n                else {\r\n                    //moving up faster than 1 m/s\r\n                }\r\n            } else if (this.penetrateSide === PenetrateSide.LEFT_TO_RIGHT) {\r\n                if (relativeVel.x < -32) //if moving down faster than 32 pixel/s (1m/s), handle as before\r\n                    return;  //point is moving into platform, leave contact solid and exit\r\n                else if (relativeVel.x < 32) { //if moving slower than 32 pixel/s (1m/s)\r\n                    cc.log(\"===-=-=-=\");\r\n                    //borderline case, moving only slightly out of platform\r\n                    platformBody.getLocalPoint(points[i], relativePoint);\r\n                    let platformFaceX = selfCollider.getAABB().width / 2;  //front of platform, should only used on a box collider\r\n                    if (relativePoint.x > platformFaceX - 0.1 * 32)\r\n                        return;  //contact point is less than 3.2pixel (10cm) inside front face of platfrom\r\n                }\r\n                else {\r\n                    //moving up faster than 1 m/s\r\n                }\r\n\r\n            } else if (this.penetrateSide === PenetrateSide.RIGHT_TO_LEFT){\r\n                if ( relativeVel.x > 32 ) //if moving up faster than 32 pixel/s (1m/s), handle as before\r\n                    return;  //point is moving into platform, leave contact solid and exit\r\n                else if ( relativeVel.x < -32 ) { //if moving slower than 32 pixel/s (1m/s)\r\n                    //borderline case, moving only slightly out of platform\r\n                    platformBody.getLocalPoint( points[i], relativePoint );\r\n                    let platformFaceX = selfCollider.getAABB().width / 2;  //front of platform, should only used on a box collider\r\n                    if ( relativePoint.x < platformFaceX - 0.1*32 )\r\n                        return;  //contact point is less than 3.2pixel (10cm) inside front face of platfrom\r\n                }\r\n                else {\r\n                    //moving up faster than 1 m/s\r\n                }\r\n            }\r\n\r\n        }\r\n\r\n        // store disabled state to contact\r\n        contact.disabled = true;\r\n    },\r\n\r\n    // called every frame, uncomment this function to activate update callback\r\n    // update: function (dt) {\r\n\r\n    // },\r\n});\r\n\r\n\r\n\r\n"]}