{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\NiuNiu\\script\\common/assets\\NiuNiu\\script\\common\\ServerTimeMgr.js"],"names":["ALLOWED_TIMESTAMP_OFFSET","ServerTimeMgr","cc","Class","properties","delayForOfflineReward","_timeStampOffset","Number","MAX_VALUE","timeStampOffset","get","set","value","log","isDeviceTimeValid","GlobalNiuNiu","config","DEBUG_MODE","gameMgr","checkForSubsReward","selOfflineRewardForAdVideo","viewMgr","showDailyRewardView","ctor","statics","instance","getInstance","loadServerTime","sys","platform","ANDROID","UtilsCross","require","xhr","loader","getXMLHttpRequest","onStreamXHREvents","open","timeout","send","method","responseHandler","forEach","eventname","onreadystatechange","readyState","status","serverTimeStamp","JSON","parse","responseText","nowTimeStamp","Date","getTime","Math","abs","e","error","message","dataMgr","playerObj","isControlTime","setServerTimeStamp","timeStamp","window","module","exports"],"mappings":"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","file":"ServerTimeMgr.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\NiuNiu\\script\\common","sourcesContent":["/**\n * Created by edisonjiang on 2018/4/23.\n */\n\n\"use strict\";\n\n// 可容忍的服务器时间戳和设备本地时间戳的偏差值(单位秒)\nconst ALLOWED_TIMESTAMP_OFFSET = 600;\n\nlet ServerTimeMgr = cc.Class({\n    properties: {\n        delayForOfflineReward: 0,\n\n        _timeStampOffset: Number.MAX_VALUE, // 服务器时间戳和设备本地时间戳的偏移量(单位秒)\n        timeStampOffset: {\n            get () {\n                return this._timeStampOffset;\n            },\n            set (value) {\n                this._timeStampOffset = value;\n                cc.log(\"this._timeStampOffset = \" + this._timeStampOffset);\n\n                // // 增加用于给予用户奖励的离线时间\n                // GlobalNiuNiu.gameMgr.addOfflineTimeForReward();\n                if (this.isDeviceTimeValid() || GlobalNiuNiu.config.DEBUG_MODE) {\n                    // 检查订阅的每日奖励\n                    GlobalNiuNiu.gameMgr.checkForSubsReward();\n                    // 检测是否给予离线奖励\n                    GlobalNiuNiu.gameMgr.selOfflineRewardForAdVideo(false, this.delayForOfflineReward);\n                    // 显示每日奖励\n                    GlobalNiuNiu.viewMgr.showDailyRewardView();\n                }\n            }\n        }\n    },\n\n    ctor(){\n    },\n\n    statics: {\n        instance: null,\n        getInstance: function () {\n            if (ServerTimeMgr.instance == null) {\n                ServerTimeMgr.instance = new ServerTimeMgr();\n            }\n            return ServerTimeMgr.instance;\n        }\n    },\n\n    /**\n     * 读取服务器时间\n     */\n    loadServerTime () {\n        if (cc.sys.platform == cc.sys.ANDROID){\n            let UtilsCross = require('UtilsCross');\n            UtilsCross.loadServerTime();\n\n            return;\n        }\n\n        var xhr = cc.loader.getXMLHttpRequest();\n        this.onStreamXHREvents(xhr, 'GET');\n\n        xhr.open(\"GET\", \"https://sec.tclclouds.com/game180412/stamp/q\", true);\n        // note: In Internet Explorer, the timeout property may be set only after calling the open()\n        // method and before calling the send() method.\n        xhr.timeout = 10000; // 10 seconds for timeout\n        xhr.send();\n    },\n\n    onStreamXHREvents (xhr, method, responseHandler ) {\n        // var handler = responseHandler || function (response) {\n        //     return method + \" Response (30 chars): \" + response.substring(0, 30) + \"...\";\n        // };\n\n        // Simple events\n        ['loadstart', 'abort', 'error', 'load', 'loadend', 'timeout'].forEach((eventname) => {\n            xhr[\"on\" + eventname] = () => {\n                if (eventname === 'timeout') {\n                    cc.log('(timeout)');\n\n                    this.timeStampOffset = Number.MAX_VALUE;\n                }\n            };\n        });\n\n        // Special event\n        xhr.onreadystatechange = () => {\n            if (xhr.readyState === 4 && (xhr.status >= 200 && xhr.status < 300)) {\n                // cc.log(handler(xhr.responseText));\n\n                try {\n                    let serverTimeStamp = JSON.parse(xhr.responseText)['Stamp'];\n                    let nowTimeStamp = new Date().getTime() / 1000;\n                    this.timeStampOffset = Math.abs(nowTimeStamp - serverTimeStamp);\n                    cc.log(\"load time Succ nowTimeStamp= \" + nowTimeStamp);\n                }\n                catch (e) {\n                    cc.log(\"load time Failed  \");\n                    cc.error(\"on loadServerTime: \" + e.message);\n                    this.timeStampOffset = Number.MAX_VALUE;\n                }\n            }else{\n                cc.log(\"load time xhr.readyState = \" + xhr.readyState + \" xhr.status = \" + xhr.status);\n            }\n        };\n    },\n\n    /**\n     * 获得设备时间是否合法\n     * @returns {boolean}\n     */\n    isDeviceTimeValid () {\n        if (GlobalNiuNiu.dataMgr.playerObj.isControlTime) {\n            return (this.timeStampOffset < ALLOWED_TIMESTAMP_OFFSET);\n        } else {\n            return true;\n        }\n    },\n\n    /**\n     * 设置服务器返回的时间戳\n     * @param {Number} timeStamp\n     */\n    setServerTimeStamp (timeStamp) {\n        let nowTimeStamp = new Date().getTime() / 1000;\n        this.timeStampOffset = Math.abs(nowTimeStamp - timeStamp);\n    }\n});\n\nwindow.ServerTimeMgr = ServerTimeMgr;\n\nmodule.exports = ServerTimeMgr;\n"]}