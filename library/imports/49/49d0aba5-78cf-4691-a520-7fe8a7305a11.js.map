{"version":3,"sources":["..\\..\\..\\..\\..\\assets\\Script\\components/assets\\Script\\components\\ShaderHelper.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"..\\..\\..\\..\\..\\assets\\Script\\components","sourcesContent":["const {ccclass, property, executeInEditMode} = cc._decorator;\n\n@ccclass('ShaderProperty')\nexport class ShaderProperty {\n    @property({readonly: true})\n    key = '';\n\n    @property(cc.Float)\n    value = 0.0;\n};\n\nconst ShaderEnum = cc.Enum({});\n\n@ccclass\n@executeInEditMode\nexport default class ShaderHelper extends cc.Component {\n    \n    //枚举Shader程序\n    @property\n    _program = 0;\n    @property({type:ShaderEnum})\n    get program() {\n        return this._program;\n    }\n    set program(value) {\n        if (this._program === value) {\n            return;\n        }\n        this._program = value;\n        this.applyEffect();\n    }\n\n    //shader参数\n    @property({type: [ShaderProperty]})\n    _props: ShaderProperty[] = [];\n    \n    @property({type: [ShaderProperty]})\n    get props() : ShaderProperty[] {\n        return this._props;\n    }\n\n    set props(value) {\n        this._props = value;    \n        this.applyEffect();\n    }\n\n    //材质对象\n    material: cc.Material = null;\n    \n    //effect的数组\n    static effectAssets: any[] = null;\n\n    start () {\n        if (CC_EDITOR) {\n            setTimeout(() => {\n                // this.applyEffect();\n            }, 1000);\n            \n        } else {\n            // this.applyEffect();\n        }\n        //this.node.on(cc.Node.EventType.TOUCH_END, this.next, this);\n    }\n\n    applyEffect(program) {\n  \n        //获取精灵组件\n        let sprite = this.node.getComponent(cc.Sprite);\n        if (!sprite) {\n            return;    \n        }\n\n        // let effectAsset = ShaderHelper.effectAssets[this.program];\n        let effectAsset = ShaderHelper.effectAssets[program];\n        //实例化一个材质对象\n        let material = new cc.Material();\n        \n        //在材质对象上开启USE_TEXTURE定义\n        let defineUserTexture = !!effectAsset.shaders.find(shader => shader.defines.find(def => def.name === 'USE_TEXTURE'));\n        if (defineUserTexture) {\n            material.define('USE_TEXTURE', true); \n        }\n\n        //为材质设置effect，也是就绑定Shader了\n        material.effectAsset = effectAsset\n        material.name = effectAsset.name;\n\n        //将材质绑定到精灵组件上，精灵可以绑定多个材质\n        //这里我们替换0号默认材质\n        sprite.setMaterial(0, material);\n\n        //从精灵组件上获取材质，这步很重要，不然没效果\n        this.material = sprite.getMaterial(0);\n        this.setProperty(effectAsset);\n        this.node.emit('effect-changed', this, this.material);\n    }\n\n    setProperty(effectAsset) {\n        if (CC_EDITOR) {\n            let oldProps = this._props;\n            this._props = [];\n\n            let keys = Object.keys(effectAsset._effect._properties);\n            //@ts-ignore\n            let values = Object.values(effectAsset._effect._properties);\n            \n            for (let i = 0; i < values.length; i++) {\n                let value: number = values[i].value;\n                let key = keys[i];\n                let type = values[i].type;\n                if (value !== null && (type === 4 || type === 13)) {\n                    let oldItem = oldProps.find(item => item.key === key);\n                    if (oldItem) {\n                        value = oldItem.value;\n                    }\n                    let sp = new ShaderProperty()\n                    sp.key = key;\n                    sp.value = typeof(value) === 'object'  ? value[0] : value;\n                    this._props.push(sp);    \n                }\n            }\n\n            // setTimeout(() => {\n                let shaderTimer = this.getComponent('ShaderTime');\n                //cc.log(shaderTimer.max);\n                if (shaderTimer) {\n                    shaderTimer.max =  shaderTimer.max;      \n                }  \n            //}, 1000);\n        }\n\n        if (this._props.length) {\n            this._props.forEach(item => item.key && this.material.setProperty(item.key, item.value || 0));\n        }\n        // @ts-ignore\n        cc.Class.Attr.setClassAttr(ShaderHelper, 'props', 'visible', !!this._props.length);    \n    }\n\n    next() {\n        this.program = (this.program + 1) % ShaderHelper.effectAssets.length;\n    }\n\n    prev() {\n        if (this.program === 0) {\n            this.program = ShaderHelper.effectAssets.length - 1;    \n            return;\n        }\n        this.program = (this.program - 1) % ShaderHelper.effectAssets.length;\n    }\n\n}\n\ncc.game.on(cc.game.EVENT_ENGINE_INITED, () => {\n    cc.dynamicAtlasManager.enabled = false;\n    cc.loader.loadResDir('effect', cc.EffectAsset ,(error, res) => {\n        ShaderHelper.effectAssets = res;\n        let array = ShaderHelper.effectAssets.map((item, i)  => { \n            return {name:item._name, value: i}; \n        });\n\n        //@ts-ignore\n        cc.Class.Attr.setClassAttr(ShaderHelper, 'program', 'enumList', array);\n    });\n})"]}