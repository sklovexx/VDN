{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\Script\\Ui\\LuckyDrawPanel/assets\\Script\\Ui\\LuckyDrawPanel\\TurntableMgr.js"],"names":["cc","Class","extends","Component","properties","boolRandom","default","displayName","tooltip","intTotalPrize","type","Integer","intResultId","floatAccelerated","Float","floatDeceleration","floatMaxRangeSpeed","initProperties","_range","_currentRotationSpeed","_targetRotation","_turntableBg","node","getChildByName","_interval","onLoad","onRandomPlace","log","random","Math","onStart","Global","PageMgr","showTipPage","_currentState","undefined","rotation","schedule","updateRotation","onStop","unschedule","onVirtualCompute","virtualRotationAngle","rotationSpeed","onGetValue","targetRotation","temp","detectionAngle","tempRotation","tempRotationSpeed","onDestroy"],"mappings":"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","file":"TurntableMgr.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\Script\\Ui\\LuckyDrawPanel","sourcesContent":["cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        boolRandom:{\n            default : false,\n            displayName : \"随机位置\",\n            tooltip : '确定结果区域后,是否在该区域内随机落下'\n        },\n\n        intTotalPrize:{\n            default : 6,\n            type : cc.Integer,\n            displayName : \"奖品/区域总数\",\n            tooltip : '游戏总奖品数'\n        },\n\n        intResultId:{\n            default : 1,\n            type : cc.Integer,\n            displayName : \"奖品/目标Id\",\n            tooltip : '中奖奖品'\n        },\n\n        floatAccelerated:{\n            default : 360 * 2,\n            type : cc.Float,\n            displayName : \"加速度\",\n            tooltip : '加速度值,每秒速度增加几度,°/s²'\n        },\n\n        floatDeceleration:{\n            default : -270,\n            type : cc.Float,\n            displayName : \"减速度\",\n            tooltip : '加速度值,每秒速度减少几度,°/s²'\n        },\n\n        floatMaxRangeSpeed:{\n            default : 360 * 3,\n            type : cc.Float,\n            displayName : \"最大速度\",\n            tooltip : '每秒速度减少几度,°/s'\n        }\n    },\n\n    // 初始化属性\n    initProperties() {\n        // 旋转角度范围\n        this._range = 360;\n        // 当前旋转速度\n        this._currentRotationSpeed = 0; \n        // 目标角度\n        this._targetRotation = 0;\n        // 目标节点\n        this._turntableBg = this.node.getChildByName(\"TurntableBg\");\n        // 说明节点\n        // this._labExplain = this.node.getChildByName(\"LabExplain\").getComponent(cc.Label);\n        // this._labExplain.string = '初始化成功' \n\n        // 处理奖品Id\n        if(this.intResultId <= 0 || this.intTotalPrize < this.intResultId || this.intTotalPrize <= 0)\n        {\n            // this._labExplain.string = '区域总数或奖品Id不准确...'\n        }\n        this.intResultId = this.intTotalPrize + 1 - this.intResultId ;\n        // 时间间隔\n        this._interval = 0.02;   \n    },\n\n    onLoad() {\n        this.initProperties();\n    },\n\n    /**\n     * 随机函数\n     * 方法: 将目标区域分为多个小块,随机落到除两边外其他位置(防止指针指到边上指示不明确)\n     */\n    onRandomPlace() {\n        cc.log(\"随机该区域内位置\")\n        var random = (Math.random() - 0.5) * this._range / (this.intTotalPrize + 2);\n        return random;\n    },\n\n    // 开始\n    onStart()\n    {\n        Global.PageMgr.showTipPage(\"每周六由官方统一抽奖\",2); \n        return;\n        if(this._currentState == undefined || this._currentState == 0)\n        {\n            this._currentState = 1; // 0:静止 1:加速 2减速\n            this._turntableBg.rotation = 0;\n        }else{\n            // cc.log(\"转盘已经开始转动...\");\n        }\n        this.schedule(this.updateRotation, this._interval);\n\n    },\n\n    // 暂停\n    onStop()\n    {\n        if(this._currentState == undefined || this._currentState == 0)\n        {\n            cc.log(\"转盘已经停止...\");\n        }else{\n            // 当前状态静止\n            // this._labExplain.string = '转盘已经暂停...'\n            this.unschedule(this.updateRotation);\n        }\n    },\n\n    // 计算开始减速时机\n    onVirtualCompute()\n    {\n        // 虚拟转动角度\n        var virtualRotationAngle = 0;\n        // 虚拟角度速度\n        var rotationSpeed = this.floatMaxRangeSpeed;\n        while(rotationSpeed > 0)\n        {\n            virtualRotationAngle = virtualRotationAngle + rotationSpeed * this._interval;\n            rotationSpeed = rotationSpeed + this._interval * this.floatDeceleration;\n        }\n\n        return virtualRotationAngle;\n    },\n\n    // 获取开始减速的时机 角度\n    onGetValue(targetRotation)\n    {\n        var temp = targetRotation - this.onVirtualCompute();\n        if(temp > 0) {\n            while (temp >= 360) {\n                temp -= this._range;\n            }\n        } else {\n            while (temp < 0) {\n                temp += this._range;\n            }\n        }\n        return temp;\n    },\n\n    /**\n     * 转动检测\n     */\n    detectionAngle() {\n        // 目标旋转角度\n        var targetRotation = this._range / this.intTotalPrize * this.intResultId;\n        if(this.boolRandom) {\n            targetRotation += this.onRandomPlace();\n        }\n        var tempRotation = this.onGetValue(targetRotation);\n        this._turntableBg.rotation = tempRotation;\n        this._currentState = 2;\n    },\n\n    /**\n     * 每一帧回调\n     * @param {*}  \n     */\n    updateRotation() {\n        switch (this._currentState) {\n            case 0:\n                // this._labExplain.string = '静止中...'\n                break;\n            case 1:\n                {\n                    if(this._currentRotationSpeed >= this.floatMaxRangeSpeed)\n                    {\n                        // this._labExplain.string = '速度到达顶峰...'\n                        this._currentRotationSpeed = this.floatMaxRangeSpeed;\n\n                        this.detectionAngle();\n                    }else\n                    {\n                        this._currentRotationSpeed += this.floatAccelerated * this._interval;\n                        // this._labExplain.string = '加速中...'\n                    }\n                }\n                break;\n            case 2:\n                {\n                    if(this._currentRotationSpeed <= 0)\n                    {\n                        // this._labExplain.string = '速度到减为0...'\n\n                        this._currentRotationSpeed = 0; //当前速度设置为 0rad/s\n                        this._currentState = 0;         //当前状态设置为 0\n                    }else{\n                        // this._labExplain.string = '减速中...'\n\n                        this._currentRotationSpeed += this.floatDeceleration * this._interval;\n                    }\n                }\n                break;\n            default:\n                {\n                    // this._labExplain.string = '未知定义状态,强行停止旋转...'\n\n                    this._currentRotationSpeed = 0; //当前速度设置为 0rad/s\n                    this._currentState = 0;         //当前状态设置为 0\n                }\n                break;\n        }\n        cc.log(\"当前旋转速度 : \",this._currentRotationSpeed);\n\n        var tempRotationSpeed = this._currentRotationSpeed * this._interval;\n        cc.log(\"当前转盘转动速度\" + tempRotationSpeed + \"°/\" + this._interval + \"s\");\n\n        // this._labExplain.string = this._labExplain.string + \"\\n当前转盘转动速度: \" +  Math.round(this._currentRotationSpeed) + \"°/s\";\n        this._turntableBg.rotation += tempRotationSpeed;\n    },\n\n    /**\n     * 统一回收组件\n     */\n    onDestroy() {\n        this.node.onDestroy();\n    }\n});"]}