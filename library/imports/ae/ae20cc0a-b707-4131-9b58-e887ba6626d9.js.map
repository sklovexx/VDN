{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\NiuNiu\\script\\net/assets\\NiuNiu\\script\\net\\HttpProxy.js"],"names":["GameHttp","require","DataMgr","FacebookMgr","UtilsCross","Md5","md5_hex_hmac","urlroot","encryptKey","cc","Class","ctor","login","onSuc","onFailed","uid","getUID","log","pObj","getInstance","playerObj","url","data","serverRequest","bindFb","sid","fbid","updateIcon","fbicon","updateName","fbname","uploadScore","score","bestScore","getRankList","getFriendsRankList","friends","installFriends","JSON","stringify","friendsSend","f","push","parseInt","encryptStr","newData","parse","encrypt","version","getAppVersion","httpPost","req","isOk","getBody","getError"],"mappings":"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","file":"HttpProxy.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\NiuNiu\\script\\net","sourcesContent":["/**\r\n * Created by skyxu on 2018/7/13.\r\n */\r\n\r\n\"use strict\";\r\n\r\nlet GameHttp = require(\"./GameHttp\");\r\nlet DataMgr = require(\"./../common/DataMgr\");\r\nlet FacebookMgr = require(\"./../common/FacebookMgr\");\r\nlet UtilsCross = require(\"./../common/UtilsCross\");\r\nlet Md5 = require(\"./../encrypt/Md5\").md5_hex_hmac;\r\n\r\n// let urlroot = \"http://localhost:3000\";\r\n// let urlroot = \"http://52.44.165.172:3000\";\r\n// let urlroot = \"http://106.55.241.55:9501/\";//测试版本ip\r\n\r\n// let urlroot = \"http://192.168.0.114:9501/\";//本地接口\r\n// let urlroot = \"http://api.vdnmetaverse.org/api/\";//正式发布\r\nlet urlroot = \"http://156.241.191.27:9501/api/\";//正式发布2\r\n\r\n\r\nlet encryptKey = \"tclsafegame\";\r\n\r\ncc.Class({\r\n    ctor(){\r\n\r\n    },\r\n\r\n    /**\r\n     *\r\n     * @param onSuc\r\n     * @param onFailed\r\n     */\r\n    login(onSuc, onFailed){\r\n        let uid = UtilsCross.getUID();\r\n        cc.log(\"uid=\" + uid);\r\n        if (!uid && onFailed){\r\n            onFailed();\r\n            return;\r\n        }\r\n\r\n        let pObj = DataMgr.getInstance().playerObj;\r\n        let url = urlroot + \"/login\";\r\n        let data = {uid: uid};\r\n        this.serverRequest(url, data, onSuc, onFailed);\r\n    },\r\n\r\n    /**\r\n     *\r\n     * @param onSuc\r\n     * @param onFailed\r\n     */\r\n    bindFb(onSuc, onFailed){\r\n        let uid = UtilsCross.getUID();\r\n        cc.log(\"uid=\" + uid);\r\n        if (!uid && onFailed){\r\n            onFailed();\r\n            return;\r\n        }\r\n\r\n        let pObj = DataMgr.getInstance().playerObj;\r\n        let url = urlroot + \"/bind_fb\";\r\n        let data = {sid: pObj.sid, fbid: pObj.fbid, uid: uid};\r\n        this.serverRequest(url, data, onSuc, onFailed);\r\n    },\r\n\r\n    /**\r\n     *\r\n     * @param onSuc\r\n     * @param onFailed\r\n     */\r\n    updateIcon(onSuc, onFailed){\r\n        let pObj = DataMgr.getInstance().playerObj;\r\n        let url = urlroot + \"/update_icon\";\r\n        let data = {fbid: pObj.fbid, fbicon: pObj.fbicon};\r\n        this.serverRequest(url, data, onSuc, onFailed);\r\n    },\r\n\r\n    /**\r\n     *\r\n     * @param onSuc\r\n     * @param onFailed\r\n     */\r\n    updateName(onSuc, onFailed){\r\n        let pObj = DataMgr.getInstance().playerObj;\r\n        let url = urlroot + \"/update_name\";\r\n        let data = {fbid: pObj.fbid, fbname: pObj.fbname};\r\n        this.serverRequest(url, data, onSuc, onFailed);\r\n    },\r\n\r\n    /**\r\n     *\r\n     * @param onSuc\r\n     * @param onFailed\r\n     */\r\n    uploadScore(onSuc, onFailed){\r\n        let pObj = DataMgr.getInstance().playerObj;\r\n        let url = urlroot + \"/upload_score\";\r\n        let data = {sid: pObj.sid, score: pObj.bestScore};\r\n        this.serverRequest(url, data, onSuc, onFailed);\r\n    },\r\n\r\n    /**\r\n     *\r\n     * @param onSuc\r\n     * @param onFailed\r\n     */\r\n    getRankList(onSuc, onFailed){\r\n        let pObj = DataMgr.getInstance().playerObj;\r\n        let url = urlroot + \"/get_rank\";\r\n        let data = {sid: pObj.sid};\r\n        this.serverRequest(url, data, onSuc, onFailed);\r\n    },\r\n\r\n    /**\r\n     *\r\n     * @param onSuc\r\n     * @param onFailed\r\n     */\r\n    getFriendsRankList(onSuc, onFailed){\r\n        let pObj = DataMgr.getInstance().playerObj;\r\n        let url = urlroot + \"/get_rank_friends\";\r\n        let friends = FacebookMgr.getInstance().installFriends;\r\n\r\n        if (pObj.fbid <= 0){\r\n            if (onFailed){\r\n                onFailed(\"Haven't any friend.\");\r\n                return;\r\n            }\r\n        }\r\n\r\n        cc.log(typeof friends + \" | \" + friends);\r\n        cc.log(\"friends + \" + JSON.stringify(friends));\r\n        let friendsSend = [];\r\n        for (let f of friends){\r\n            friendsSend.push(parseInt(f.uid));\r\n        }\r\n        cc.log(typeof friendsSend + \" | \" + friendsSend);\r\n        cc.log(JSON.stringify(friendsSend));\r\n\r\n        let data = {fbid: pObj.fbid, friends: friendsSend};\r\n        cc.log(\"get friend rank: \" + JSON.stringify(data));\r\n\r\n        this.serverRequest(url, data, onSuc, onFailed);\r\n    },\r\n\r\n    /**\r\n     *\r\n     * @param url\r\n     * @param data\r\n     * @param onSuc\r\n     * @param onFailed\r\n     */\r\n    serverRequest(url, data, onSuc, onFailed){\r\n        cc.log(\"serverRequest: \" + typeof data + \" | \" + JSON.stringify(data));\r\n        data = typeof data === \"string\" ? data : JSON.stringify(data);\r\n        // 加密校验传输\r\n        let encryptStr = Md5(encryptKey, data);\r\n        let newData = {\r\n            data: JSON.parse(data),\r\n            encrypt: encryptStr,\r\n            version: UtilsCross.getAppVersion() || \"2.0.0\"\r\n        };\r\n        newData = JSON.stringify(newData);\r\n\r\n        GameHttp.httpPost(url, newData, (req)=>{\r\n            if (req.isOk()){\r\n                cc.log(\"requrest: \" + url + \" 成功。\");\r\n                if (onSuc){\r\n                    onSuc(req.getBody());\r\n                }\r\n            } else {\r\n                cc.log(\"requrest: \" + url + \" 失败。\");\r\n                if (onFailed){\r\n                    onFailed(req.getError() || req.getBody());\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n"]}