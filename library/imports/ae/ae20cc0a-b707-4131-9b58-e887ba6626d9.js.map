{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\NiuNiu\\script\\net/assets\\NiuNiu\\script\\net\\HttpProxy.js"],"names":["GameHttp","require","DataMgr","FacebookMgr","UtilsCross","Md5","md5_hex_hmac","urlroot","encryptKey","cc","Class","ctor","login","onSuc","onFailed","uid","getUID","log","pObj","getInstance","playerObj","url","data","serverRequest","bindFb","sid","fbid","updateIcon","fbicon","updateName","fbname","uploadScore","score","bestScore","getRankList","getFriendsRankList","friends","installFriends","JSON","stringify","friendsSend","f","push","parseInt","encryptStr","newData","parse","encrypt","version","getAppVersion","httpPost","req","isOk","getBody","getError"],"mappings":";;;;AAAA;;;;AAIA;;;;AAEA,IAAIA,WAAWC,QAAQ,YAAR,CAAf;AACA,IAAIC,UAAUD,QAAQ,qBAAR,CAAd;AACA,IAAIE,cAAcF,QAAQ,yBAAR,CAAlB;AACA,IAAIG,aAAaH,QAAQ,wBAAR,CAAjB;AACA,IAAII,MAAMJ,QAAQ,kBAAR,EAA4BK,YAAtC;;AAEA;AACA;AACA;;AAEA;AACA,IAAIC,UAAU,kCAAd,EAAiD;;AAEjD,IAAIC,aAAa,aAAjB;;AAEAC,GAAGC,KAAH,CAAS;AACLC,QADK,kBACC,CAEL,CAHI;;;AAKL;;;;;AAKAC,SAVK,iBAUCC,KAVD,EAUQC,QAVR,EAUiB;AAClB,YAAIC,MAAMX,WAAWY,MAAX,EAAV;AACAP,WAAGQ,GAAH,CAAO,SAASF,GAAhB;AACA,YAAI,CAACA,GAAD,IAAQD,QAAZ,EAAqB;AACjBA;AACA;AACH;;AAED,YAAII,OAAOhB,QAAQiB,WAAR,GAAsBC,SAAjC;AACA,YAAIC,MAAMd,UAAU,QAApB;AACA,YAAIe,OAAO,EAACP,KAAKA,GAAN,EAAX;AACA,aAAKQ,aAAL,CAAmBF,GAAnB,EAAwBC,IAAxB,EAA8BT,KAA9B,EAAqCC,QAArC;AACH,KAtBI;;;AAwBL;;;;;AAKAU,UA7BK,kBA6BEX,KA7BF,EA6BSC,QA7BT,EA6BkB;AACnB,YAAIC,MAAMX,WAAWY,MAAX,EAAV;AACAP,WAAGQ,GAAH,CAAO,SAASF,GAAhB;AACA,YAAI,CAACA,GAAD,IAAQD,QAAZ,EAAqB;AACjBA;AACA;AACH;;AAED,YAAII,OAAOhB,QAAQiB,WAAR,GAAsBC,SAAjC;AACA,YAAIC,MAAMd,UAAU,UAApB;AACA,YAAIe,OAAO,EAACG,KAAKP,KAAKO,GAAX,EAAgBC,MAAMR,KAAKQ,IAA3B,EAAiCX,KAAKA,GAAtC,EAAX;AACA,aAAKQ,aAAL,CAAmBF,GAAnB,EAAwBC,IAAxB,EAA8BT,KAA9B,EAAqCC,QAArC;AACH,KAzCI;;;AA2CL;;;;;AAKAa,cAhDK,sBAgDMd,KAhDN,EAgDaC,QAhDb,EAgDsB;AACvB,YAAII,OAAOhB,QAAQiB,WAAR,GAAsBC,SAAjC;AACA,YAAIC,MAAMd,UAAU,cAApB;AACA,YAAIe,OAAO,EAACI,MAAMR,KAAKQ,IAAZ,EAAkBE,QAAQV,KAAKU,MAA/B,EAAX;AACA,aAAKL,aAAL,CAAmBF,GAAnB,EAAwBC,IAAxB,EAA8BT,KAA9B,EAAqCC,QAArC;AACH,KArDI;;;AAuDL;;;;;AAKAe,cA5DK,sBA4DMhB,KA5DN,EA4DaC,QA5Db,EA4DsB;AACvB,YAAII,OAAOhB,QAAQiB,WAAR,GAAsBC,SAAjC;AACA,YAAIC,MAAMd,UAAU,cAApB;AACA,YAAIe,OAAO,EAACI,MAAMR,KAAKQ,IAAZ,EAAkBI,QAAQZ,KAAKY,MAA/B,EAAX;AACA,aAAKP,aAAL,CAAmBF,GAAnB,EAAwBC,IAAxB,EAA8BT,KAA9B,EAAqCC,QAArC;AACH,KAjEI;;;AAmEL;;;;;AAKAiB,eAxEK,uBAwEOlB,KAxEP,EAwEcC,QAxEd,EAwEuB;AACxB,YAAII,OAAOhB,QAAQiB,WAAR,GAAsBC,SAAjC;AACA,YAAIC,MAAMd,UAAU,eAApB;AACA,YAAIe,OAAO,EAACG,KAAKP,KAAKO,GAAX,EAAgBO,OAAOd,KAAKe,SAA5B,EAAX;AACA,aAAKV,aAAL,CAAmBF,GAAnB,EAAwBC,IAAxB,EAA8BT,KAA9B,EAAqCC,QAArC;AACH,KA7EI;;;AA+EL;;;;;AAKAoB,eApFK,uBAoFOrB,KApFP,EAoFcC,QApFd,EAoFuB;AACxB,YAAII,OAAOhB,QAAQiB,WAAR,GAAsBC,SAAjC;AACA,YAAIC,MAAMd,UAAU,WAApB;AACA,YAAIe,OAAO,EAACG,KAAKP,KAAKO,GAAX,EAAX;AACA,aAAKF,aAAL,CAAmBF,GAAnB,EAAwBC,IAAxB,EAA8BT,KAA9B,EAAqCC,QAArC;AACH,KAzFI;;;AA2FL;;;;;AAKAqB,sBAhGK,8BAgGctB,KAhGd,EAgGqBC,QAhGrB,EAgG8B;AAC/B,YAAII,OAAOhB,QAAQiB,WAAR,GAAsBC,SAAjC;AACA,YAAIC,MAAMd,UAAU,mBAApB;AACA,YAAI6B,UAAUjC,YAAYgB,WAAZ,GAA0BkB,cAAxC;;AAEA,YAAInB,KAAKQ,IAAL,IAAa,CAAjB,EAAmB;AACf,gBAAIZ,QAAJ,EAAa;AACTA,yBAAS,qBAAT;AACA;AACH;AACJ;;AAEDL,WAAGQ,GAAH,CAAO,QAAOmB,OAAP,yCAAOA,OAAP,KAAiB,KAAjB,GAAyBA,OAAhC;AACA3B,WAAGQ,GAAH,CAAO,eAAeqB,KAAKC,SAAL,CAAeH,OAAf,CAAtB;AACA,YAAII,cAAc,EAAlB;AAd+B;AAAA;AAAA;;AAAA;AAe/B,iCAAcJ,OAAd,8HAAsB;AAAA,oBAAbK,CAAa;;AAClBD,4BAAYE,IAAZ,CAAiBC,SAASF,EAAE1B,GAAX,CAAjB;AACH;AAjB8B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAkB/BN,WAAGQ,GAAH,CAAO,QAAOuB,WAAP,yCAAOA,WAAP,KAAqB,KAArB,GAA6BA,WAApC;AACA/B,WAAGQ,GAAH,CAAOqB,KAAKC,SAAL,CAAeC,WAAf,CAAP;;AAEA,YAAIlB,OAAO,EAACI,MAAMR,KAAKQ,IAAZ,EAAkBU,SAASI,WAA3B,EAAX;AACA/B,WAAGQ,GAAH,CAAO,sBAAsBqB,KAAKC,SAAL,CAAejB,IAAf,CAA7B;;AAEA,aAAKC,aAAL,CAAmBF,GAAnB,EAAwBC,IAAxB,EAA8BT,KAA9B,EAAqCC,QAArC;AACH,KAzHI;;;AA2HL;;;;;;;AAOAS,iBAlIK,yBAkISF,GAlIT,EAkIcC,IAlId,EAkIoBT,KAlIpB,EAkI2BC,QAlI3B,EAkIoC;AACrCL,WAAGQ,GAAH,CAAO,4BAA2BK,IAA3B,yCAA2BA,IAA3B,KAAkC,KAAlC,GAA0CgB,KAAKC,SAAL,CAAejB,IAAf,CAAjD;AACAA,eAAO,OAAOA,IAAP,KAAgB,QAAhB,GAA2BA,IAA3B,GAAkCgB,KAAKC,SAAL,CAAejB,IAAf,CAAzC;AACA;AACA,YAAIsB,aAAavC,IAAIG,UAAJ,EAAgBc,IAAhB,CAAjB;AACA,YAAIuB,UAAU;AACVvB,kBAAMgB,KAAKQ,KAAL,CAAWxB,IAAX,CADI;AAEVyB,qBAASH,UAFC;AAGVI,qBAAS5C,WAAW6C,aAAX,MAA8B;AAH7B,SAAd;AAKAJ,kBAAUP,KAAKC,SAAL,CAAeM,OAAf,CAAV;;AAEA7C,iBAASkD,QAAT,CAAkB7B,GAAlB,EAAuBwB,OAAvB,EAAgC,UAACM,GAAD,EAAO;AACnC,gBAAIA,IAAIC,IAAJ,EAAJ,EAAe;AACX3C,mBAAGQ,GAAH,CAAO,eAAeI,GAAf,GAAqB,MAA5B;AACA,oBAAIR,KAAJ,EAAU;AACNA,0BAAMsC,IAAIE,OAAJ,EAAN;AACH;AACJ,aALD,MAKO;AACH5C,mBAAGQ,GAAH,CAAO,eAAeI,GAAf,GAAqB,MAA5B;AACA,oBAAIP,QAAJ,EAAa;AACTA,6BAASqC,IAAIG,QAAJ,MAAkBH,IAAIE,OAAJ,EAA3B;AACH;AACJ;AACJ,SAZD;AAaH;AA3JI,CAAT","file":"HttpProxy.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\NiuNiu\\script\\net","sourcesContent":["/**\n * Created by skyxu on 2018/7/13.\n */\n\n\"use strict\";\n\nlet GameHttp = require(\"./GameHttp\");\nlet DataMgr = require(\"./../common/DataMgr\");\nlet FacebookMgr = require(\"./../common/FacebookMgr\");\nlet UtilsCross = require(\"./../common/UtilsCross\");\nlet Md5 = require(\"./../encrypt/Md5\").md5_hex_hmac;\n\n// let urlroot = \"http://localhost:3000\";\n// let urlroot = \"http://52.44.165.172:3000\";\n// let urlroot = \"http://106.55.241.55:9501/\";//测试版本ip\n\n// let urlroot = \"http://192.168.2.99:9501/\";//本地接口\nlet urlroot = \"http://api.vdnmetaverse.org/api/\";//正式发布\n\nlet encryptKey = \"tclsafegame\";\n\ncc.Class({\n    ctor(){\n\n    },\n\n    /**\n     *\n     * @param onSuc\n     * @param onFailed\n     */\n    login(onSuc, onFailed){\n        let uid = UtilsCross.getUID();\n        cc.log(\"uid=\" + uid);\n        if (!uid && onFailed){\n            onFailed();\n            return;\n        }\n\n        let pObj = DataMgr.getInstance().playerObj;\n        let url = urlroot + \"/login\";\n        let data = {uid: uid};\n        this.serverRequest(url, data, onSuc, onFailed);\n    },\n\n    /**\n     *\n     * @param onSuc\n     * @param onFailed\n     */\n    bindFb(onSuc, onFailed){\n        let uid = UtilsCross.getUID();\n        cc.log(\"uid=\" + uid);\n        if (!uid && onFailed){\n            onFailed();\n            return;\n        }\n\n        let pObj = DataMgr.getInstance().playerObj;\n        let url = urlroot + \"/bind_fb\";\n        let data = {sid: pObj.sid, fbid: pObj.fbid, uid: uid};\n        this.serverRequest(url, data, onSuc, onFailed);\n    },\n\n    /**\n     *\n     * @param onSuc\n     * @param onFailed\n     */\n    updateIcon(onSuc, onFailed){\n        let pObj = DataMgr.getInstance().playerObj;\n        let url = urlroot + \"/update_icon\";\n        let data = {fbid: pObj.fbid, fbicon: pObj.fbicon};\n        this.serverRequest(url, data, onSuc, onFailed);\n    },\n\n    /**\n     *\n     * @param onSuc\n     * @param onFailed\n     */\n    updateName(onSuc, onFailed){\n        let pObj = DataMgr.getInstance().playerObj;\n        let url = urlroot + \"/update_name\";\n        let data = {fbid: pObj.fbid, fbname: pObj.fbname};\n        this.serverRequest(url, data, onSuc, onFailed);\n    },\n\n    /**\n     *\n     * @param onSuc\n     * @param onFailed\n     */\n    uploadScore(onSuc, onFailed){\n        let pObj = DataMgr.getInstance().playerObj;\n        let url = urlroot + \"/upload_score\";\n        let data = {sid: pObj.sid, score: pObj.bestScore};\n        this.serverRequest(url, data, onSuc, onFailed);\n    },\n\n    /**\n     *\n     * @param onSuc\n     * @param onFailed\n     */\n    getRankList(onSuc, onFailed){\n        let pObj = DataMgr.getInstance().playerObj;\n        let url = urlroot + \"/get_rank\";\n        let data = {sid: pObj.sid};\n        this.serverRequest(url, data, onSuc, onFailed);\n    },\n\n    /**\n     *\n     * @param onSuc\n     * @param onFailed\n     */\n    getFriendsRankList(onSuc, onFailed){\n        let pObj = DataMgr.getInstance().playerObj;\n        let url = urlroot + \"/get_rank_friends\";\n        let friends = FacebookMgr.getInstance().installFriends;\n\n        if (pObj.fbid <= 0){\n            if (onFailed){\n                onFailed(\"Haven't any friend.\");\n                return;\n            }\n        }\n\n        cc.log(typeof friends + \" | \" + friends);\n        cc.log(\"friends + \" + JSON.stringify(friends));\n        let friendsSend = [];\n        for (let f of friends){\n            friendsSend.push(parseInt(f.uid));\n        }\n        cc.log(typeof friendsSend + \" | \" + friendsSend);\n        cc.log(JSON.stringify(friendsSend));\n\n        let data = {fbid: pObj.fbid, friends: friendsSend};\n        cc.log(\"get friend rank: \" + JSON.stringify(data));\n\n        this.serverRequest(url, data, onSuc, onFailed);\n    },\n\n    /**\n     *\n     * @param url\n     * @param data\n     * @param onSuc\n     * @param onFailed\n     */\n    serverRequest(url, data, onSuc, onFailed){\n        cc.log(\"serverRequest: \" + typeof data + \" | \" + JSON.stringify(data));\n        data = typeof data === \"string\" ? data : JSON.stringify(data);\n        // 加密校验传输\n        let encryptStr = Md5(encryptKey, data);\n        let newData = {\n            data: JSON.parse(data),\n            encrypt: encryptStr,\n            version: UtilsCross.getAppVersion() || \"2.0.0\"\n        };\n        newData = JSON.stringify(newData);\n\n        GameHttp.httpPost(url, newData, (req)=>{\n            if (req.isOk()){\n                cc.log(\"requrest: \" + url + \" 成功。\");\n                if (onSuc){\n                    onSuc(req.getBody());\n                }\n            } else {\n                cc.log(\"requrest: \" + url + \" 失败。\");\n                if (onFailed){\n                    onFailed(req.getError() || req.getBody());\n                }\n            }\n        });\n    }\n});\n"]}