{"version":3,"sources":["..\\..\\..\\..\\assets\\Script/assets\\Script\\HotUpdate.js"],"names":["cc","Class","extends","Component","properties","manifestUrl","type","Asset","default","infoLb","Label","searchPathsLb","_updating","_canRetry","_storagePath","checkCb","event","log","getEventCode","jsb","EventAssetsManager","ERROR_NO_LOCAL_MANIFEST","string","director","loadScene","ERROR_DOWNLOAD_MANIFEST","ERROR_PARSE_MANIFEST","ALREADY_UP_TO_DATE","NEW_VERSION_FOUND","scheduleOnce","hotUpdate","_am","setEventCallback","_checkListener","updateCb","needRestart","failed","UPDATE_PROGRESSION","msg","getMessage","getPercentByFile","console","UPDATE_FINISHED","UPDATE_FAILED","ERROR_UPDATING","ERROR_DECOMPRESS","_updateListener","searchPaths","fileUtils","getSearchPaths","newPaths","getLocalManifest","JSON","stringify","Array","prototype","unshift","apply","sys","localStorage","setItem","setSearchPaths","audioEngine","stopAll","game","restart","retry","downloadFailedAssets","checkUpdate","getState","AssetsManager","State","UNINITED","url","nativeUrl","loader","md5Pipe","transformURL","loadLocalManifest","isLoaded","bind","_failCount","update","onLoad","isNative","getWritablePath","versionCompareHandle","versionA","versionB","vA","split","vB","i","length","a","parseInt","b","self","setVerifyCallback","path","asset","compressed","expectedMD5","md5","relativePath","size","os","OS_ANDROID","setMaxConcurrentTask","onDestroy"],"mappings":"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","file":"HotUpdate.js","sourceRoot":"..\\..\\..\\..\\assets\\Script","sourcesContent":["// pscp F:\\test\\hotupdate\\ver-1.0.5\\hotupdate.zip root@123.207.111.47:/var/www/html/wechatGame/test/\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        manifestUrl: {\r\n            type: cc.Asset,\r\n            default: null\r\n        },\r\n        infoLb : cc.Label,\r\n        searchPathsLb : cc.Label,\r\n        _updating: false,\r\n        _canRetry: false,\r\n        _storagePath: ''\r\n    },\r\n\r\n    checkCb: function (event) {\r\n        cc.log('Code: ' + event.getEventCode());\r\n        switch (event.getEventCode())\r\n        {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                this.infoLb.string = \"本地没有发现manifest文件，跳过更新.\";\r\n                cc.director.loadScene('ECC');\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                this.infoLb.string = \"更新失败，跳过更新.\";\r\n                cc.director.loadScene('ECC');\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                this.infoLb.string = \"已经是最新版本,即将进入游戏.\";\r\n                cc.director.loadScene('ECC');\r\n                break;\r\n            case jsb.EventAssetsManager.NEW_VERSION_FOUND:\r\n                this.infoLb.string = '发现新版本,即将开始更新.';\r\n                this.scheduleOnce(this.hotUpdate, 1)\r\n                break;\r\n            default:\r\n                return;\r\n        }\r\n        \r\n        this._am.setEventCallback(null);\r\n        this._checkListener = null;\r\n        this._updating = false;\r\n    },\r\n\r\n    updateCb: function (event) {\r\n        var needRestart = false;\r\n        var failed = false;\r\n        switch (event.getEventCode())\r\n        {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                this.infoLb.string = \"本地没有发现manifest文件，跳过更新.\";\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_PROGRESSION:\r\n                var msg = event.getMessage();\r\n                if (msg) {\r\n                    this.infoLb.string = '正在更新...';\r\n                    this.searchPathsLb.string = event.getPercentByFile() / 100 + \"%\";\r\n                    console.log(event.getPercentByFile() / 100 + '% : ' + msg);\r\n                }\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                this.infoLb.string = \"更新失败，跳过更新.\";\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                this.infoLb.string = \"已经是最新版本,即将进入游戏.\";\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FINISHED:\r\n                this.infoLb.string = \"更新已完成，等待重启游戏.\";\r\n                needRestart = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FAILED:\r\n                this.infoLb.string = \"更新失败，跳过更新.\";\r\n                this._updating = false;\r\n                this._canRetry = true;\r\n                cc.director.loadScene('ECC');\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_UPDATING:\r\n                this.infoLb.string = \"更新失败，跳过更新.\";\r\n                cc.director.loadScene('ECC');\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DECOMPRESS:\r\n                this.infoLb.string = \"文件比对错误\";\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n\r\n        if (failed) {\r\n            this._am.setEventCallback(null);\r\n            this._updateListener = null;\r\n            this._updating = false;\r\n            cc.director.loadScene('ECC');\r\n        }\r\n\r\n        if (needRestart) {\r\n            this._am.setEventCallback(null);\r\n            this._updateListener = null;\r\n            // Prepend the manifest's search path\r\n            var searchPaths = jsb.fileUtils.getSearchPaths();\r\n            var newPaths = this._am.getLocalManifest().getSearchPaths();\r\n            console.log(JSON.stringify(newPaths));\r\n            Array.prototype.unshift.apply(searchPaths, newPaths);\r\n            // This value will be retrieved and appended to the default search path during game startup,\r\n            // please refer to samples/js-tests/main.js for detailed usage.\r\n            // !!! Re-add the search paths in main.js is very important, otherwise, new scripts won't take effect.\r\n            cc.sys.localStorage.setItem('HotUpdateSearchPaths', JSON.stringify(searchPaths));\r\n            jsb.fileUtils.setSearchPaths(searchPaths);\r\n\r\n            cc.audioEngine.stopAll();\r\n            cc.game.restart();\r\n        }\r\n    },\r\n    \r\n    retry: function () {\r\n        if (!this._updating && this._canRetry) {\r\n            this._canRetry = false;\r\n            \r\n            this.infoLb.string = '更新失败';\r\n            this._am.downloadFailedAssets();\r\n        }\r\n    },\r\n    \r\n    checkUpdate: function () {\r\n        if (this._updating) {\r\n            this.infoLb.string = '正在检查更新.';\r\n            return;\r\n        }\r\n        if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n            // Resolve md5 url\r\n            var url = this.manifestUrl.nativeUrl;\r\n            if (cc.loader.md5Pipe) {\r\n                url = cc.loader.md5Pipe.transformURL(url);\r\n            }\r\n            this._am.loadLocalManifest(url);\r\n        }\r\n        if (!this._am.getLocalManifest() || !this._am.getLocalManifest().isLoaded()) {\r\n            this.infoLb.string = \"本地没有发现manifest文件，跳过更新.\";\r\n            cc.director.loadScene('ECC');\r\n            return;\r\n        }\r\n        this._am.setEventCallback(this.checkCb.bind(this));\r\n\r\n        this._am.checkUpdate();\r\n        this._updating = true;\r\n    },\r\n\r\n    hotUpdate: function () {\r\n        if (this._am && !this._updating) {\r\n            this._am.setEventCallback(this.updateCb.bind(this));\r\n\r\n            if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n                // Resolve md5 url\r\n                var url = this.manifestUrl.nativeUrl;\r\n                if (cc.loader.md5Pipe) {\r\n                    url = cc.loader.md5Pipe.transformURL(url);\r\n                }\r\n                this._am.loadLocalManifest(url);\r\n            }\r\n\r\n            this._failCount = 0;\r\n            this._am.update();\r\n            this._updating = true;\r\n        }\r\n    },\r\n   \r\n    // use this for initialization\r\n    onLoad: function () {\r\n        // Hot update is only available in Native build\r\n        if (!cc.sys.isNative) {\r\n            cc.director.loadScene('ECC');\r\n            return;\r\n        }\r\n        // this.searchPathsLb.string = jsb.fileUtils.getSearchPaths()\r\n\r\n        this._storagePath = ((jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + 'blackjack-remote-asset');\r\n        cc.log('Storage path for remote asset : ' + this._storagePath);\r\n// cc.log('SearchPaths:' + jsb.fileUtils.getSearchPaths())\r\n        // Setup your own version compare handler, versionA and B is versions in string\r\n        // if the return value greater than 0, versionA is greater than B,\r\n        // if the return value equals 0, versionA equals to B,\r\n        // if the return value smaller than 0, versionA is smaller than B.\r\n        this.versionCompareHandle = function (versionA, versionB) {\r\n            cc.log(\"JS Custom Version Compare: version A is \" + versionA + ', version B is ' + versionB);\r\n            var vA = versionA.split('.');\r\n            var vB = versionB.split('.');\r\n            for (var i = 0; i < vA.length; ++i) {\r\n                var a = parseInt(vA[i]);\r\n                var b = parseInt(vB[i] || 0);\r\n                if (a === b) {\r\n                    continue;\r\n                }\r\n                else {\r\n                    return a - b;\r\n                }\r\n            }\r\n            if (vB.length > vA.length) {\r\n                return -1;\r\n            }\r\n            else {\r\n                return 0;\r\n            }\r\n        };\r\n\r\n        // Init with empty manifest url for testing custom manifest\r\n        this._am = new jsb.AssetsManager('', this._storagePath, this.versionCompareHandle);\r\n\r\n        var self = this;\r\n        this.infoLb.string = '正在检查更新.';\r\n        // Setup the verification callback, but we don't have md5 check function yet, so only print some message\r\n        // Return true if the verification passed, otherwise return false\r\n        this._am.setVerifyCallback(function (path, asset) {\r\n            // When asset is compressed, we don't need to check its md5, because zip file have been deleted.\r\n            var compressed = asset.compressed;\r\n            // Retrieve the correct md5 value.\r\n            var expectedMD5 = asset.md5;\r\n            // asset.path is relative path and path is absolute.\r\n            var relativePath = asset.path;\r\n            // The size of asset file, but this value could be absent.\r\n            var size = asset.size;\r\n            if (compressed) {\r\n                // self.infoLb.string = \"Verification passed : \" + relativePath;\r\n                return true;\r\n            }\r\n            else {\r\n                // self.infoLb.string = \"Verification passed : \" + relativePath + ' (' + expectedMD5 + ')';\r\n                return true;\r\n            }\r\n        });\r\n\r\n        \r\n\r\n        if (cc.sys.os === cc.sys.OS_ANDROID) {\r\n            // Some Android device may slow down the download process when concurrent tasks is too much.\r\n            // The value may not be accurate, please do more test and find what's most suitable for your game.\r\n            this._am.setMaxConcurrentTask(2);\r\n            // this.infoLb.string = \"Max concurrent tasks count have been limited to 2\";\r\n        }\r\n\r\n        this.scheduleOnce(this.checkUpdate, 1)\r\n    },\r\n\r\n    onDestroy: function () {\r\n        if (this._updateListener) {\r\n            this._am.setEventCallback(null);\r\n            this._updateListener = null;\r\n        }\r\n    }\r\n});\r\n"]}