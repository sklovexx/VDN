{"version":3,"sources":["IapTools.js"],"names":["IapTools","window","buy","key","sucCallback","failedCallback","GlobalNiuNiu","config","DEBUG_MODE","onBuySuc","cc","sys","isNative","log","ret","platform","IPHONE","IPAD","jsb","reflection","callStaticMethod","ANDROID","buySubs","getSubsSize","restorePurchase","JSON","parse","length","onBuyFailed","code","onRestoreFinished","ok","msg","verifyVip","dataMgr","iapObj","vipValid"],"mappings":"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","file":"IapTools.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\NiuNiu\\script\\common","sourcesContent":["/**\r\n * Created by skyxu on 2018/5/3.\r\n *\r\n * 由于作用域问题，这里无法使用require来的模块\r\n */\r\n\r\n\"use strict\";\r\nlet IapTools = IapTools || {};\r\n\r\n// mark: 必须放到全局里，不然OC无法调用到\r\nwindow.IapTools = IapTools;\r\n\r\n/**\r\n *\r\n * @param key{String} 参考GCONFIG.IAPCFG\r\n * @param sucCallback{Function} 购买成功的回调\r\n * @param failedCallback{Function} 购买失败的回调\r\n * @returns {string}\r\n */\r\nIapTools.buy = function (key, sucCallback, failedCallback) {\r\n    if (GlobalNiuNiu.config.DEBUG_MODE){\r\n        // mark: 测试模式直接购买成功\r\n        IapTools.sucCallback = sucCallback;\r\n        IapTools.onBuySuc(key);\r\n        return;\r\n    }\r\n\r\n    if (!cc.sys.isNative) {\r\n        cc.log(\"only native can use iap.\");\r\n        return;\r\n    }\r\n\r\n    IapTools.sucCallback = sucCallback;\r\n    IapTools.failedCallback = failedCallback;\r\n\r\n    let ret = \"\";\r\n    if (cc.sys.platform === cc.sys.IPHONE || cc.sys.platform === cc.sys.IPAD) {\r\n        ret = jsb.reflection.callStaticMethod(\"HKPayManagerSolitaire\",\"applePay:\", key);\r\n    } else if(cc.sys.platform === cc.sys.ANDROID){\r\n        // todo: Android\r\n        cc.log(\"iaptools buy android:\" + key);\r\n        jsb.reflection.callStaticMethod(\"org/cocos2dx/javascript/AppActivity\",\"purchaseInApp\", \"(Ljava/lang/String;)V\", key);\r\n    }\r\n\r\n    return ret;\r\n};\r\n\r\n// 购买订阅服务\r\nIapTools.buySubs = function (key, sucCallback, failedCallback) {\r\n    if (GlobalNiuNiu.config.DEBUG_MODE){\r\n        // mark: 测试模式直接购买成功\r\n        IapTools.sucCallback = sucCallback;\r\n        IapTools.onBuySuc(key);\r\n        return;\r\n    }\r\n\r\n    if (!cc.sys.isNative) {\r\n        cc.log(\"only native can use iap.\");\r\n        return;\r\n    }\r\n\r\n    IapTools.sucCallback = sucCallback;\r\n    IapTools.failedCallback = failedCallback;\r\n\r\n    let ret = \"\";\r\n    if (cc.sys.platform === cc.sys.IPHONE || cc.sys.platform === cc.sys.IPAD) {\r\n        ret = jsb.reflection.callStaticMethod(\"HKPayManagerSolitaire\",\"applePay:\", key);\r\n    } else if(cc.sys.platform === cc.sys.ANDROID){\r\n        // todo: Android\r\n        cc.log(\"iaptools buy android:\" + key);\r\n        jsb.reflection.callStaticMethod(\"org/cocos2dx/javascript/AppActivity\",\"purchaseSubs\", \"(Ljava/lang/String;)V\", key);\r\n    }\r\n\r\n    return ret;\r\n};\r\n\r\n/**\r\n * 获取当前可用的订阅数 -1 查询失败 0 没有有效的订阅 >1 具有有效的订阅\r\n  * @return {number}\r\n */\r\nIapTools.getSubsSize = function () {\r\n    let ret = 0;\r\n    if (!cc.sys.isNative) {\r\n        cc.log(\"only native can buySubs.\");\r\n        return ret;\r\n    }\r\n\r\n    if (cc.sys.platform === cc.sys.ANDROID) {\r\n        ret = jsb.reflection.callStaticMethod(\"org/cocos2dx/javascript/AppActivity\",\"getPurchasesSubsSize\", \"()I\");\r\n    }\r\n\r\n    return ret;\r\n};\r\n\r\n/**\r\n * 恢复购买（每次从后台进入前台都会自动调用,一般不需要用户手动处理)\r\n * @param sucCallback{Function} 成功的回调\r\n * @param failedCallbace{Function} 失败的回调\r\n * @returns {string}\r\n */\r\nIapTools.restorePurchase = function (sucCallback, failedCallback) {\r\n    if (!cc.sys.isNative) {\r\n        cc.log(\"only native can use iap.\");\r\n        return;\r\n    }\r\n\r\n    IapTools.sucCallback = sucCallback;\r\n    IapTools.failedCallback = failedCallback;\r\n\r\n    let ret = \"\";\r\n    if (cc.sys.platform === cc.sys.IPHONE || cc.sys.platform === cc.sys.IPAD) {\r\n        ret = jsb.reflection.callStaticMethod(\"HKPayManagerSolitaire\",\"restorePurchase\");\r\n    }else if(cc.sys.platform == cc.sys.ANDROID){\r\n        ret = jsb.reflection.callStaticMethod(\"org/cocos2dx/javascript/AppActivity\",\"restorePurchase\", \"()Ljava/lang/String;\");\r\n        cc.log('restore suc ret:' + ret);\r\n        let ret = JSON.parse(ret);\r\n        cc.log(ret.length);\r\n    }\r\n    else {\r\n\r\n    }\r\n\r\n    return ret;\r\n};\r\n\r\n/**\r\n *\r\n * @param key{String} 参考GCONFIG.IAPCFG\r\n */\r\nIapTools.onBuySuc = function (key) {\r\n    cc.log(\"js购买成功. key=\" + key);\r\n    if (IapTools.sucCallback){\r\n        IapTools.sucCallback(key);\r\n        IapTools.sucCallback = null;\r\n    }\r\n};\r\n\r\n/**\r\n *\r\n * @param code{String}\r\n */\r\nIapTools.onBuyFailed = function (code) {\r\n    cc.log(\"js购买失败. code=\" + code);\r\n    if (IapTools.failedCallback){\r\n        IapTools.failedCallback(code);\r\n        IapTools.failedCallback = null;\r\n    }\r\n};\r\n\r\nIapTools.onRestoreFinished = function (ok, msg) {\r\n    cc.log('IapTools.onRestoreFinished: ' + ok + \", \" + msg);\r\n    // mark: 目前只有vip订阅\r\n    cc.log(\"js恢复购买成功.\");\r\n    if (IapTools.sucCallback){\r\n        IapTools.sucCallback();\r\n    }\r\n};\r\n\r\n/**\r\n * 验证vip订阅是否有效\r\n * @param ret {String} \"true\" or \"false\"\r\n */\r\nIapTools.verifyVip = function (ret) {\r\n    cc.log(\"js verify Vip:\" + ret);\r\n    if (ret === \"true\"){\r\n        GlobalNiuNiu.dataMgr.iapObj.vipValid = true;\r\n    } else {\r\n        GlobalNiuNiu.dataMgr.iapObj.vipValid = false;\r\n    }\r\n};\r\n"]}