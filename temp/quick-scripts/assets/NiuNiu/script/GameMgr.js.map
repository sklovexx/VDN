{"version":3,"sources":["GameMgr.js"],"names":["Toast","require","dataMgr","getInstance","cc","Class","extends","Component","properties","onLoad","GlobalNiuNiu","gameMgr","start","listenEvent","eventMgr","on","config","EVENT_NETWORK_OPENED","onNetOpen","EVENT_NETWORK_CLOSED","onNetClosed","EVENT_LOGIN_SUC","onLoginSuc","EVENT_LOGIN_FAILED","onLoginFailed","event","log","connectState","netProxy","login","showText","scheduleOnce","dt","isNetworkOpened","connect","resp","uid","playerObj","parse","saveDataToLocal","startBeatHeart","schedule","checkInternet","t","Date","now","beatHeart","JSON","stringify","onOpenRoom","err","loadScene","setTimeout","emit","EVENT_OPEN_ROOM","onEnterRoom","EVENT_ENTER_ROOM"],"mappings":"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","file":"GameMgr.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\NiuNiu\\script","sourcesContent":["/**\r\n * Created by skyxu on 2019/3/28.\r\n */\r\n\r\n\"use strict\";\r\n\r\nlet Toast = require(\"./views/ToastCtrl\");\r\nlet dataMgr = require(\"./common/DataMgr\").getInstance();\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {},\r\n\r\n    onLoad(){\r\n        GlobalNiuNiu.gameMgr = this;\r\n    },\r\n\r\n    start(){\r\n        this.listenEvent();\r\n    },\r\n\r\n    listenEvent(){\r\n        GlobalNiuNiu.eventMgr.on(GlobalNiuNiu.config.EVENT_NETWORK_OPENED, this.onNetOpen, this);\r\n        GlobalNiuNiu.eventMgr.on(GlobalNiuNiu.config.EVENT_NETWORK_CLOSED, this.onNetClosed, this);\r\n        GlobalNiuNiu.eventMgr.on(GlobalNiuNiu.config.EVENT_LOGIN_SUC, this.onLoginSuc, this);\r\n        GlobalNiuNiu.eventMgr.on(GlobalNiuNiu.config.EVENT_LOGIN_FAILED, this.onLoginFailed, this);\r\n    },\r\n\r\n    onNetOpen(event){\r\n        cc.log(\"net opened.\");\r\n        // this.startBeatHeart();\r\n        GlobalNiuNiu.connectState = true;\r\n        GlobalNiuNiu.netProxy.login(0);\r\n    },\r\n\r\n    onNetClosed(event){\r\n        cc.log(\"net closed. 5s 后重试连接.\");\r\n        Toast.showText(\"网络连接失败，正在重试.\", 2);\r\n        GlobalNiuNiu.connectState = false;\r\n        this.scheduleOnce((dt)=>{\r\n            if (!GlobalNiuNiu.netProxy.isNetworkOpened()){\r\n                GlobalNiuNiu.netProxy.connect();\r\n            }\r\n        }, 5);\r\n\r\n    },\r\n\r\n    onLoginSuc(event){\r\n        let resp = event;\r\n        cc.log(\"登陆成功.\");\r\n        cc.log(event)\r\n        if (resp.uid != null){\r\n            dataMgr.playerObj.parse(resp);\r\n            dataMgr.saveDataToLocal();\r\n        }\r\n    },\r\n\r\n    onLoginFailed(event){\r\n        cc.log(\"登陆失败. 5s后重试.\");\r\n        this.scheduleOnce((dt)=>{\r\n            GlobalNiuNiu.netProxy.login(0);\r\n        }, 5)\r\n    },\r\n\r\n    startBeatHeart(){\r\n        this.schedule((dt)=>{\r\n            if (!this.checkInternet()) return;\r\n            let t = Date.now();\r\n            GlobalNiuNiu.netProxy.beatHeart((resp)=>{\r\n                cc.log(JSON.stringify(resp));\r\n                cc.log(\"delay: \" + (resp.t - t));\r\n            });\r\n        }, 5);\r\n    },\r\n\r\n    checkInternet(){\r\n        return GlobalNiuNiu.netProxy.isNetworkOpened();\r\n    },\r\n\r\n    onOpenRoom(resp){\r\n        if (resp.err > 0){\r\n            Toast.showText(\"开房失败.\", 2);\r\n            return;\r\n        }\r\n        GlobalNiuNiu.loadScene(\"RoomNet\",()=>{\r\n            setTimeout(()=>{\r\n                GlobalNiuNiu.eventMgr.emit(GlobalNiuNiu.config.EVENT_OPEN_ROOM, resp);\r\n            },1000)\r\n        });\r\n    },\r\n\r\n    onEnterRoom(resp){\r\n        if (resp.err > 0){\r\n            Toast.showText(\"加入失败，请检查房间号.\", 2);\r\n            return;\r\n        }\r\n        GlobalNiuNiu.loadScene(\"RoomNet\",()=>{\r\n            setTimeout(()=>{\r\n                GlobalNiuNiu.eventMgr.emit(GlobalNiuNiu.config.EVENT_ENTER_ROOM, resp);\r\n            },1000)\r\n        });\r\n    }\r\n});\r\n"]}